<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>飞书写入测试 · 皮影收集器</title>
<style>
  :root{--bg:#0b1220;--card:#0f172a;--ink:#e5e7eb;--muted:#9ca3af;--brand:#60a5fa;--ok:#34d399;--warn:#f59e0b}
  *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,"PingFang SC","Microsoft YaHei";background:var(--bg);color:var(--ink)}
  .wrap{max-width:760px;margin:0 auto;padding:18px}
  .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
  h1,h2{margin:0 0 12px}
  .muted{color:var(--muted);font-size:14px}
  label{display:block;margin:10px 0 6px}
  input,select,button,textarea{width:100%;border-radius:12px;border:1px solid #1f2937;padding:10px 12px;background:#0b1220;color:#fff}
  button{background:var(--brand);color:#09111f;font-weight:700;cursor:pointer;border:none}
  button.ghost{background:#0b1220;color:#fff;border:1px solid #374151}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .ok{color:#10b981}.err{color:#ef4444}
  pre{background:#0b1220;border:1px solid #374151;border-radius:12px;padding:12px;white-space:pre-wrap;word-break:break-all}
  .hint{font-size:12px;color:#9ca3af;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>飞书写入测试 · 皮影收集器</h1>
    <p class="muted">此页面专门用于测试「游戏 → Vercel 后端 → 飞书多维表格」的上报链路。<br>
    ⚠️ 字段名与类型固定为 <strong>5 项</strong>：<code>昵称、年级、班级、第3关步数、是否看视频</code>（“是否看视频”必须是“是/否”）。</p>
  </div>

  <div class="card">
    <h2>填写一条测试数据</h2>
    <div class="row">
      <div>
        <label>昵称</label>
        <input id="name" placeholder="如：六（3）-29 / 测试同学">
      </div>
      <div>
        <label>年级</label>
        <select id="grade">
          <option value="">请选择</option>
          <option>一年级</option><option>二年级</option><option>三年级</option>
          <option>四年级</option><option>五年级</option><option>六年级</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>班级</label>
        <input id="klass" placeholder="如：3班">
      </div>
      <div>
        <label>第3关步数（数字）</label>
        <input id="moves" type="number" min="0" step="1" placeholder="如：8">
      </div>
    </div>
    <label>是否看视频</label>
    <select id="seen">
      <option>是</option>
      <option>否</option>
    </select>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="send">提交到云端（飞书）</button>
      <button class="ghost" id="mock">一键填入示例</button>
      <a class="ghost" id="health" href="https://piying-feishu-backend.vercel.app/api/collect" target="_blank" style="display:inline-block;text-decoration:none;padding:10px 12px;border-radius:12px;border:1px solid #374151">查看后端健康 (GET)</a>
    </div>

    <div class="hint">后端地址：<code>https://piying-feishu-backend.vercel.app/api/collect</code>（已对接飞书平台并配置 App Token / App ID / App Secret / Table ID）。</div>
  </div>

  <div class="card">
    <h2>提交结果</h2>
    <div id="status" class="muted">尚未提交</div>
    <pre id="resp"></pre>
  </div>

  <div class="card">
    <h2>给前端（游戏）的调用示例</h2>
    <p class="muted">你的游戏里只要调用下面这段函数即可（和你刚才能写入的那版完全一致）：</p>
<pre>
async function reportToCloud(rec) {
  const payload = {
    fields: {
      "昵称": rec.name || "",
      "年级": rec.grade || "",
      "班级": rec.class || "",
      "第3关步数": Number(rec.l3_moves || 0),
      "是否看视频": rec.v_seen ? "是" : "否",
    },
  };
  const r = await fetch("https://piying-feishu-backend.vercel.app/api/collect", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  return await r.json();
}
</pre>
  </div>

</div>

<script>
const ENDPOINT = "https://piying-feishu-backend.vercel.app/api/collect";

function $(s){return document.querySelector(s)}
function show(obj){
  $("#resp").textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
}

$("#mock").onclick = ()=>{
  $("#name").value = "测试同学";
  $("#grade").value = "六年级";
  $("#klass").value = "3班";
  $("#moves").value = "8";
  $("#seen").value = "是";
  $("#status").textContent = "已填入示例，请点【提交到云端】";
  $("#status").className = "muted";
};

$("#send").onclick = async ()=>{
  const payload = {
    fields: {
      "昵称": ($("#name").value||"").trim(),
      "年级": ($("#grade").value||"").trim(),
      "班级": ($("#klass").value||"").trim(),
      "第3关步数": Number($("#moves").value||0),
      "是否看视频": ($("#seen").value === "是" ? "是" : "否"),
    }
  };

  // 简单校验
  if(!payload.fields["昵称"] || !payload.fields["年级"] || !payload.fields["班级"]){
    $("#status").textContent = "请把 昵称 / 年级 / 班级 填完整再提交";
    $("#status").className = "err";
    return;
  }

  $("#status").textContent = "正在提交...";
  $("#status").className = "muted";
  show(payload);

  try{
    const resp = await fetch(ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await resp.json().catch(()=> ({}));
    show(data);
    if(resp.ok && data && (data.ok || data.code===0)){
      $("#status").textContent = "✅ 提交成功，去飞书表里看看是否新增一行。";
      $("#status").className = "ok";
    }else{
      $("#status").textContent = "⚠️ 提交返回非 200 或后端未确认成功，请看下面返回内容。";
      $("#status").className = "err";
    }
  }catch(e){
    $("#status").textContent = "❌ 网络异常或后端不可达，请稍后再试。";
    $("#status").className = "err";
    show(String(e));
  }
};
</script>
</body>
</html>
