<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>腾冲皮影戏 · 数据收集</title>
  <style>
    body{font-family:system-ui,-apple-system,"PingFang SC";background:#0b1220;color:#e5e7eb;margin:0;padding:20px}
    .wrap{max-width:720px;margin:auto}
    .card{background:#0f172a;padding:16px;border-radius:12px;margin-bottom:16px}
    label{display:block;margin:8px 0}
    input,select,button{padding:8px 12px;border-radius:8px;border:1px solid #374151;background:#1f2937;color:#fff}
    button{background:#3b82f6;color:#fff;border:none;cursor:pointer}
    button:disabled{opacity:.5}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #374151;padding:6px 8px;text-align:left;font-size:14px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>腾冲皮影戏 · 数据收集</h1>
    <label>昵称 <input id="name" placeholder="如：张三" /></label>
    <label>年级 
      <select id="grade">
        <option value="">请选择</option>
        <option>一年级</option><option>二年级</option><option>三年级</option>
        <option>四年级</option><option>五年级</option><option>六年级</option>
      </select>
    </label>
    <label>班级 <input id="klass" placeholder="如：3班" /></label>
    <label>第3关步数 <input type="number" id="moves" value="0" /></label>
    <label>是否看视频 
      <select id="seen"><option value="是">是</option><option value="否">否</option></select>
    </label>
    <button id="submit">提交数据</button>
  </div>

  <div class="card">
    <h2>本机排行榜</h2>
    <table id="board"><thead><tr><th>#</th><th>昵称</th><th>年级</th><th>班级</th><th>步数</th><th>看视频</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<script>
const CLOUD_ENDPOINT = "https://piying-feishu-backend.vercel.app/api/collect";
const STORAGE_KEY = "piying_records";

function loadRecords(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]")}catch{return[]}}
function saveRecords(all){localStorage.setItem(STORAGE_KEY,JSON.stringify(all))}
function refreshBoard(){
  const tb=document.querySelector("#board tbody");tb.innerHTML="";
  loadRecords().forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.grade}</td><td>${r.class}</td><td>${r.moves}</td><td>${r.seen}</td>`;
    tb.appendChild(tr);
  });
}

document.querySelector("#submit").onclick=async()=>{
  const rec={
    name:document.querySelector("#name").value,
    grade:document.querySelector("#grade").value,
    class:document.querySelector("#klass").value,
    moves:Number(document.querySelector("#moves").value),
    seen:document.querySelector("#seen").value
  };
  const all=loadRecords();all.push(rec);saveRecords(all);refreshBoard();

  const payload={
    feishu:{
      "昵称":rec.name,
      "年级":rec.grade,
      "班级":rec.class,
      "第3关步数":rec.moves,
      "是否看视频":rec.seen
    }
  };

  try{
    const resp=await fetch(CLOUD_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const data=await resp.json();
    console.log("云端返回：",data);
    if(!data.ok) alert("上传失败，但已保存本机");
    else alert("✅ 已保存并上传成功");
  }catch(e){
    alert("网络异常，已保存本机，稍后再试");
  }
};

refreshBoard();
</script>
</body>
</html>
